#!/usr/bin/env bash
set -euo pipefail

### CONFIGURATION ###
CLUSTER_NAME="boutique-k8s-cluster"
REGION="eu-central-1"
POLICY_NAME="EKS-Cluster-Autoscaler-Policy"
SERVICE_ACCOUNT_NAMESPACE="kube-system"
SERVICE_ACCOUNT_NAME="cluster-autoscaler"
AUTOSCALER_VERSION="v1.29.0"   # dopasuj do wersji K8S w klastrze
ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)

echo "=== [1/8] Czyszczenie poprzedniej konfiguracji ==="
set +e
kubectl delete deployment.apps/cluster-autoscaler -n ${SERVICE_ACCOUNT_NAMESPACE} --ignore-not-found
kubectl delete serviceaccount ${SERVICE_ACCOUNT_NAME} -n ${SERVICE_ACCOUNT_NAMESPACE} --ignore-not-found
aws iam delete-role-policy --role-name eksctl-${CLUSTER_NAME}-addon-iamserviceaccount-${SERVICE_ACCOUNT_NAMESPACE}-${SERVICE_ACCOUNT_NAME}-Role1 --policy-name ${POLICY_NAME} 2>/dev/null
aws iam detach-role-policy --role-name eksctl-${CLUSTER_NAME}-addon-iamserviceaccount-${SERVICE_ACCOUNT_NAMESPACE}-${SERVICE_ACCOUNT_NAME}-Role1 \
  --policy-arn arn:aws:iam::${ACCOUNT_ID}:policy/${POLICY_NAME} 2>/dev/null
aws iam delete-role --role-name eksctl-${CLUSTER_NAME}-addon-iamserviceaccount-${SERVICE_ACCOUNT_NAMESPACE}-${SERVICE_ACCOUNT_NAME}-Role1 2>/dev/null
set -e

echo "=== [2/8] Tworzenie polityki IAM (jeśli nie istnieje) ==="
if ! aws iam get-policy --policy-arn arn:aws:iam::${ACCOUNT_ID}:policy/${POLICY_NAME} >/dev/null 2>&1; then
  aws iam create-policy \
    --policy-name ${POLICY_NAME} \
    --policy-document '{
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "autoscaling:DescribeAutoScalingGroups",
            "autoscaling:DescribeAutoScalingInstances",
            "autoscaling:DescribeLaunchConfigurations",
            "autoscaling:DescribeTags",
            "autoscaling:SetDesiredCapacity",
            "autoscaling:TerminateInstanceInAutoScalingGroup",
            "ec2:DescribeLaunchTemplateVersions"
          ],
          "Resource": "*"
        }
      ]
    }'
else
  echo "Policy ${POLICY_NAME} already exists — skipping creation."
fi

echo "=== [3/8] Tworzenie IRSA dla Cluster Autoscalera ==="
eksctl create iamserviceaccount \
  --name ${SERVICE_ACCOUNT_NAME} \
  --namespace ${SERVICE_ACCOUNT_NAMESPACE} \
  --cluster ${CLUSTER_NAME} \
  --attach-policy-arn arn:aws:iam::${ACCOUNT_ID}:policy/${POLICY_NAME} \
  --approve \
  --region ${REGION} \
  --override-existing-serviceaccounts \

echo "=== [4/8] Weryfikacja ServiceAccount ==="
kubectl get sa ${SERVICE_ACCOUNT_NAME} -n ${SERVICE_ACCOUNT_NAMESPACE} -o yaml | grep eks.amazonaws.com/role-arn || {
  echo "❌ Brak adnotacji IRSA w ServiceAccount — sprawdź eksctl output!" && exit 1
}

echo "=== [5/8] Instalacja Cluster Autoscalera ==="
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cluster-autoscaler
  namespace: kube-system
  labels:
    app: cluster-autoscaler
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cluster-autoscaler
  template:
    metadata:
      labels:
        app: cluster-autoscaler
      annotations:
        cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
    spec:
      serviceAccountName: ${SERVICE_ACCOUNT_NAME}
      containers:
      - name: cluster-autoscaler
        image: registry.k8s.io/autoscaling/cluster-autoscaler:${AUTOSCALER_VERSION}
        command:
        - ./cluster-autoscaler
        - --v=4
        - --stderrthreshold=info
        - --cloud-provider=aws
        - --skip-nodes-with-local-storage=false
        - --expander=least-waste
        - --balance-similar-node-groups
        - --aws-use-static-instance-list=false
        - --aws-region=${REGION}
        - --scale-down-delay-after-add=2m
        - --scale-down-unneeded-time=2m
        - --scale-down-utilization-threshold=0.5
        - --nodes=2:10:<your-nodegroup-name>
        env:
        - name: AWS_REGION
          value: ${REGION}
        resources:
          requests:
            cpu: 100m
            memory: 300Mi
          limits:
            cpu: 300m
            memory: 600Mi
EOF

echo "=== [6/8] Oznaczanie poda jako chronionego przed usunięciem ==="
kubectl -n kube-system annotate deployment cluster-autoscaler \
  cluster-autoscaler.kubernetes.io/safe-to-evict="false" --overwrite

echo "=== [7/8] Czekam na start poda ==="
sleep 20
kubectl get pods -n kube-system -l app=cluster-autoscaler

echo "=== [8/8] Logi (ostatnie linie) ==="
kubectl logs -n kube-system -l app=cluster-autoscaler --tail=30
echo "✅ Cluster Autoscaler setup completed successfully!"
